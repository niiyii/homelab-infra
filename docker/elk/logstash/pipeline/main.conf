input {
  # Beats input (Filebeat, Metricbeat)
  beats {
    port => 5044
    ssl => false
  }
  
  # TCP input for generic logs
  tcp {
    port => 5000
    codec => json
  }
}

filter {
  # Add hostname field if missing
  if ![host][name] {
    mutate {
      add_field => { "[host][name]" => "unknown" }
    }
  }
  
  # Parse Jellyfin logs
  if [fields][service] == "jellyfin" {
    grok {
      match => { 
        "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] \[%{WORD:log_level}\] %{GREEDYDATA:log_message}"
      }
      overwrite => ["message"]
    }
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
    mutate {
      remove_field => ["timestamp"]
    }
  }
  
  # Parse system logs (syslog format)
  if [fileset][name] == "syslog" {
    grok {
      match => {
        "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:hostname} %{DATA:program}(?:\[%{POSINT:pid}\])?: %{GREEDYDATA:syslog_message}"
      }
    }
  }
  
  # Add environment tag
  mutate {
    add_field => { "environment" => "homelab" }
  }
  
  # GeoIP for any IP addresses (optional)
  if [source][ip] {
    geoip {
      source => "[source][ip]"
      target => "[source][geo]"
    }
  }
}

output {
  # Route to appropriate indices
  if [@metadata][beat] == "filebeat" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      index => "filebeat-%{+YYYY.MM.dd}"
    }
  } else if [@metadata][beat] == "metricbeat" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      index => "metricbeat-%{+YYYY.MM.dd}"
    }
  } else {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      index => "logs-%{+YYYY.MM.dd}"
    }
  }
  
  # Debug output (comment out in production)
  # stdout { codec => rubydebug }
}